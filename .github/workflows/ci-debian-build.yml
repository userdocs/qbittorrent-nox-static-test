name: ci - debian build

on:
  workflow_call:
    inputs:
      distinct_id:
        description: "Distinct id"
        required: false
        type: string
      workflow-files:
        description: "Alpine: workflow-files files"
        required: true
        type: string
      icu:
        description: "enable icu"
        required: true
        type: string
      debug:
        description: "debug builds"
        required: true
        type: string
      script_name:
        description: "script name"
        required: true
        type: string

jobs:
  build:
    defaults:
      run:
        shell: bash
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        runs_on: ["ubuntu-24.04", "ubuntu-24.04-arm"]
        container_id: ["debian", "ubuntu"]
        container_codename: ["bookworm", "noble"]
        qbt_build_tool: ["cmake"]
        qbt_libtorrent_version: ["1.2", "2.0"]
        qbt_cross_name: ["", "aarch64", "x86_64", "riscv64"]
        exclude:
          - container_id: "debian"
            qbt_cross_name: "riscv64"
          - container_id: "debian"
            container_codename: "noble"
          - container_id: "ubuntu"
            container_codename: "bookworm"
          - runs_on: "ubuntu-24.04"
            qbt_cross_name: "x86_64"
          - runs_on: "ubuntu-24.04-arm"
            qbt_cross_name: "aarch64"
        include:
          - runs_on: "ubuntu-24.04"
            host_name: "x86_64"
          - runs_on: "ubuntu-24.04-arm"
            host_name: "aarch64"
          - qbt_build_tool: "cmake"
            qbt_qt_version: "6"

    name: "${{ matrix.host_name }}-${{ matrix.qbt_cross_name }}-${{ matrix.container_id }}-${{ matrix.container_codename }}-${{ matrix.qbt_libtorrent_version }}-qt-${{ matrix.qbt_qt_version }}-${{ matrix.qbt_build_tool }}"

    env: # host
      qbt_build_dir: "qbt-build"
      qbt_host_deps: "yes"
      disable_qt5: ""
      artifact_name: "${{ matrix.host_name }}-${{ matrix.qbt_cross_name }}-${{ matrix.container_id }}-${{ matrix.container_codename }}-${{ matrix.qbt_libtorrent_version }}-qt-${{ matrix.qbt_qt_version }}-${{ matrix.qbt_build_tool }}-nox"
      script_name: ${{ inputs.script_name }}

    container:
      image: ${{ matrix.container_id }}:${{ matrix.container_codename }}
      env: # container
        LANG: C.UTF-8
        LC_ALL: C.UTF-8
        DEBIAN_FRONTEND: noninteractive
        disable_qt5: ${{ env.disable_qt5 }}
        qbt_revision_url: ${{ github.repository }}
        qbt_zlib_type: "zlib"
        qbt_skip_icu: ${{ inputs.icu }}
        qbt_boost_tag: ${{ matrix.qbt_boost_tag }}
        qbt_libtorrent_version: ${{ matrix.qbt_libtorrent_version }}
        qbt_libtorrent_tag: ${{ matrix.qbt_libtorrent_tag }}
        qbt_libtorrent_master_jamfile: ""
        qbt_qt_version: ${{ matrix.qbt_qt_version }}
        qbt_qt_tag: ${{ matrix.qbt_qt_tag }}
        qbt_qbittorrent_tag: ${{ matrix.qbt_qbittorrent_tag }}
        qbt_build_dir: ${{ env.qbt_build_dir }}
        qbt_build_tool: ${{ matrix.qbt_build_tool }}
        qbt_cross_name: ${{ matrix.qbt_cross_name }}
        qbt_mcm_url: "userdocs/qbt-musl-cross-make-test"
        qbt_patches_url: ${{ github.repository }}
        qbt_workflow_files: ${{ inputs.workflow-files }}
        qbt_cache_dir: ""
        qbt_optimise_strip: ""
        qbt_build_debug: ${{ inputs.debug }}
        qbt_standard: ""
        qbt_static_ish: ""
        qbt_optimise: ""
        qbt_with_qemu: "no"
        qbt_host_deps: ${{ env.qbt_host_deps }}
        qbt_host_deps_url: ""
        qbt_host_deps_repo: "userdocs/qbt-host-deps-test"

    steps:
      - name: Checkout ${{ inputs.distinct_id }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: bootstrap patches ${{ inputs.distinct_id }}
        run: mkdir -p ${qbt_build_dir}/patches && cp -r patches/* ${qbt_build_dir}/patches/

      - name: Bootstrap core deps ${{ inputs.distinct_id }}
        run: bash ${script_name} bootstrap_deps

      - name: Bootstrap build ${{ inputs.distinct_id }}
        run: bash ${script_name} -bs-a

      - name: glibc ${{ inputs.distinct_id }}
        run: bash ${script_name} glibc

      - name: zlib ${{ inputs.distinct_id }}
        run: bash ${script_name} zlib

      - name: iconv ${{ inputs.distinct_id }}
        run: bash ${script_name} iconv

      - name: icu ${{ inputs.distinct_id }}
        run: bash ${script_name} icu

      - name: openssl ${{ inputs.distinct_id }}
        run: bash ${script_name} openssl

      - name: boost ${{ inputs.distinct_id }}
        run: bash ${script_name} boost

      - name: libtorrent ${{ inputs.distinct_id }}
        run: bash ${script_name} libtorrent

      - name: double conversion ${{ inputs.distinct_id }}
        if: matrix.qbt_build_tool == 'cmake'
        run: bash ${script_name} double_conversion

      - name: qtbase ${{ inputs.distinct_id }}
        run: bash ${script_name} qtbase

      - name: qttools ${{ inputs.distinct_id }}
        run: bash ${script_name} qttools

      - name: qbittorrent ${{ inputs.distinct_id }}
        run: bash ${script_name} qbittorrent

      - name: Upload ${{ env.artifact_name }} artifacts ${{ inputs.distinct_id }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact_name }}
          path: ${{ env.qbt_build_dir }}/completed/qbittorrent-nox

      - name: Host - Upload logs on error
        if: ( cancelled() || failure() )
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.artifact_name }}-logs"
          path: "${{ env.qbt_build_dir }}"
